{% extends '_base.html' %}

{% block content %}

{% load static %}

<script>
    function toggleReplyForm(id) {
        const form = document.getElementById(`reply-form-${id}`);
        form.classList.toggle("d-none");
    }

    function toggleReplies(commentId) {
        let container = document.getElementById("replies-" + commentId);
        if (container.classList.contains("d-none")) {
            container.classList.remove("d-none");
        } else {
            container.classList.add("d-none");
        }
    }
</script>

<style>
    .comment-box {
        position: relative;
    }

    .comment-actions {
        position: absolute;
        bottom: 8px;
        right: 8px;
        display: flex;
        gap: 5px;
    }
</style>

<div class="container" style="position: relative;">
    <div class="row">
        <div class="col-8" >
            <div class="card p-3">
                <div class="col mb-3">
                    <div class="row d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <img 
                                src="{{ post.author.profile.profile_picture.url }}" 
                                class="rounded-circle border"
                                style="height: 40px; width: 40px;">

                            <div class="ml-2">
                                <p class="font-weight-bold mb-0" style="font-size: 16px;">
                                    <a href="/user/profile/{{ post.author.profile.id }}" class="text-decoration-none">
                                        {{ post.author.profile.display_name }}
                                    </a>
                                </p>

                                <p class="text-muted mb-0" style="font-size: 12px;">
                                    @{{ post.author.username }} âˆ™ on {{ post.posted|date:"M d, Y" }} {% if post.edited != False %}(edited){% endif %}
                                </p>
                            </div>
                        </div>

                        <button type="button" class="btn d-flex align-items-center justify-content-center rounded-circle p-0" style="height: 30px; width: 30px;">
                            <i class="fas fa-fw fa-ellipsis-v text-dark" style="font-size: 12px;"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <p class="font-weight-bold mb-0 text-dark" style="font-size: 24px;">{{ post.title }}</p>
                    <div class="d-flex align-items-center my-3">
                        <p class="bg-secondary text-white d-flex align-items-center justify-content-center rounded px-2 mb-0" style="font-size: 12px;">
                            {{ post.tag }}
                        </p>
                    </div>
                    
                    <p class="text-justify text-dark">{{ post.content }}</p>
                </div>

                <div class="d-flex">
                    <div class="btn-group" role="group">
                        <form method="post" action="{% if post.id not in positive_feedbacks %}{% url 'feedback_post' %}{% else %}{% url 'null_feedback' %}{% endif %}"> {% csrf_token %}
                            <input type="hidden" name="post_id" value="{{ post.id }}">

                            {% if post.id not in positive_feedbacks %}

                                <input type="hidden" name="feedback" value="like">

                            {% endif %}

                            <button type="submit" class="btn btn-light d-flex align-items-center justify-content-center border" style="height: 40px; border-radius: 20px 0px 0px 20px; font-size: 12px;">
                                <i class="{% if post.id not in positive_feedbacks %} text-dark {% else %} text-success {% endif %} fas fa-fw fa-caret-up" style="font-size: 20px;"></i>
                                <p class="mb-0 ml-2">{{ post.get_likes }}</p>
                            </button>
                        </form>

                        <form method="post" action="{% if post.id not in negative_feedbacks %}{% url 'feedback_post' %}{% else %}{% url 'null_feedback' %}{% endif %}"> {% csrf_token %}
                            <input type="hidden" name="post_id" value="{{ post.id }}">

                            {% if post.id not in negative_feedbacks %}

                                <input type="hidden" name="feedback" value="dislike">

                            {% endif %}

                            <button type="submit" class="btn btn-light d-flex align-items-center justify-content-center border" style="height: 40px; border-radius: 0px 20px 20px 0px; font-size: 12px;">
                                <i class="{% if post.id not in negative_feedbacks %} text-dark {% else %} text-danger {% endif %} fas fa-fw fa-caret-down" style="font-size: 20px;"></i>
                                <p class="mb-0 ml-2">{{ post.get_dislikes }}</p>
                            </button>
                        </form>
                    </div>

                    <button type="button" class="btn btn-light d-flex align-items-center justify-content-center border rounded-pill ml-2" style="font-size: 12px;">
                        <i class="text-dark fas fa-fw fa-link"></i>

                        <p class="mb-0 ml-2">Share</p>
                    </button>
                </div>

                <p class="text-dark font-weight-bold p-0 my-3" style="font-size: 20px;">{{ post.get_comments_count }} Comment(s)</p>

                <div class="d-flex">
                    <img 
                        src="{{ user.profile.profile_picture.url }}" 
                        class="rounded-circle border"
                        style="height: 40px; width: 40px;">

                    <form method="post" action="{% url 'comment' %}" class="w-100"> {% csrf_token %}
                        <div class="comment-box ml-3">
                            <textarea 
                                class="form-control rounded"
                                name="content" 
                                rows="2" 
                                placeholder="Write your comment here..."
                                style="min-height: 60px; max-height: 200px; font-size: 14px;"
                                required></textarea>

                            <input type="hidden" name="post" value="{{ post.id }}">

                            <div class="comment-actions">
                                <button type="button" 
                                        class="btn btn-dark d-flex align-items-center justify-content-center border" 
                                        onclick="this.closest('form').reset()"
                                        style="height: 30px;">
                                        
                                    <span style="font-size: 12px;">Cancel</span>
                                </button>

                                <button type="submit"
                                        class="btn text-dark d-flex align-items-center justify-content-center rounded-circle p-0"
                                        style="height: 30px; width: 30px;">

                                    <i class="fas fa-fw fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                    
                {% for comment in comments %}

                    {% include "post/comments.html" with comment=comment %}

                {% endfor %}

            </div>
        </div>

        <div class="col-4">
            <div>
                <p class="font-weight-bold mb-1" style="font-size: 16px;">COMMUNITY INFO:</p>

                <div class="card">
                    <img class="card-img-top border-bottom" src="{% static 'img/gradient-02.jpg' %}" style="height: 80px;">
                    
                    <div class="col p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <img 
                                    src="{% static 'img/gradient-01.jpg' %}" 
                                    class="rounded-circle border"
                                    style="height: 40px; width: 40px;">

                                <div class="ml-2">
                                    <p class="font-weight-bold mb-0" style="font-size: 16px;">
                                        <a href="/community/page/{{ post.community.id }}" class="text-decoration-none">
                                            {{ post.community.name }}
                                        </a>
                                    </p>

                                    <p class="text-muted mb-0" style="font-size: 12px;">
                                        @{{ post.community.name }}
                                    </p>
                                </div>
                            </div>

                            <form method="post" action="{% url 'join' %}"> {% csrf_token %}
                                <input type="hidden" name="community_id" value="{{ post.community.id }}">
                                <button type="submit" class="btn btn-primary d-flex align-items-center justify-content-center border rounded-pill px-3" style="height: 30px; font-size: 12px;">
                                    <span class="font-weight-bold">Join</span>
                                </button>
                            </form>
                        </div>

                        <div class="my-3">
                            <p class="text-justify text-dark">{{ post.community.description }}</p>
                        </div>
                        
                        <hr class="sidebar-divider">

                        <div class="d-flex align-items-center justify-content-between">
                            <span style="font-size: 12px;"><i class="fas fa-fw fa-users"></i> 2.4k Members</span>
                            <span class="mx-3" style="font-size: 12px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-fire" viewBox="0 0 16 16">
                                    <path d="M8 16c3.314 0 6-2 6-5.5 0-1.5-.5-4-2.5-6 .25 1.5-1.25 2-1.25 2C11 4 9 .5 6 0c.357 2 .5 4-2 6-1.25 1-2 2.729-2 4.5C2 14 4.686 16 8 16m0-1c-1.657 0-3-1-3-2.75 0-.75.25-2 1.25-3C6.125 10 7 10.5 7 10.5c-.375-1.25.5-3.25 2-3.5-.179 1-.25 2 1 3 .625.5 1 1.364 1 2.25C11 14 9.657 15 8 15"/>
                                </svg> Top 1%</span>
                            <a href="#" class="btn btn-dark d-flex align-items-center justify-content-center border rounded px-3" style="font-size: 12px;">
                                <span class="font-weight-bold">{{ post.community.tag }}</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <p class="font-weight-bold mb-1" style="font-size: 16px;">AUTHOR INFO:</p>

                <div class="card">
                    <img class="card-img-top border-bottom" src="{{ post.author.profile.banner.url }}" style="height: 80px;">
                    
                    <div class="col p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <img 
                                    src="{{ post.author.profile.profile_picture.url }}" 
                                    class="rounded-circle border"
                                    style="height: 40px; width: 40px;">

                                <div class="ml-2">
                                    <p class="font-weight-bold mb-0" style="font-size: 16px;">
                                        <a href="/user/profile/{{ post.author.profile.id }}" class="text-decoration-none">
                                            {{ post.author.profile.display_name }}
                                        </a>
                                    </p>

                                    <p class="text-muted mb-0" style="font-size: 12px;">
                                        @{{ post.author.username }}
                                    </p>
                                </div>
                            </div>

                            <form method="post" action="{% url 'follow' %}"> {% csrf_token %}
                                <input type="hidden" name="followed_id" value="{{ post.author.id }}">
                                <button type="submit" class="btn btn-primary d-flex align-items-center justify-content-center border rounded-pill px-3" style="height: 30px; font-size: 12px;">
                                    <span class="font-weight-bold">Follow</span>
                                </button>
                            </form>
                        </div>

                        <div class="my-3">
                            <p class="text-justify text-dark">{{ post.author.profile.bio }}</p>
                        </div>
                        
                        <hr class="sidebar-divider">

                        <div class="d-flex align-items-center justify-content-between">
                            <span style="font-size: 12px;"><i class="fas fa-fw fa-users"></i> 55k Followers</span>
                            <!-- <span style="font-size: 12px;"><i class="fas fa-fw fa-calendar"></i> Joined {{ post.author.date_joined|date:"M d, Y" }}</span> -->
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock content %}
