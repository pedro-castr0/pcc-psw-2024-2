{% extends '_base.html' %}

{% block content %}

{% load static %}

<div style="max-width: 740px; margin: auto; background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,.08);">
  <h1 style="margin: 0 0 16px; font-size: 22px; font-weight: 700;">
    {% if post.id %}‚úèÔ∏è Editar Post{% else %}üìù Criar Post{% endif %}
  </h1>

  <form id="post-form" method="post" enctype="multipart/form-data" action="{% url 'create' %}">
    {% csrf_token %}

    <!-- T√≠tulo -->
    <label for="post-title" style="font-weight: 600;">T√≠tulo</label>
    <input id="post-title" name="title" type="text" value="{{ post.title }}" required
           style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #dcdcdc; margin: 6px 0 14px;">

    <!-- Editor Rich Text -->
    <label style="font-weight: 600;">Conte√∫do</label>
    <div id="post-editor" style="height: 240px; margin-top: 6px;" class="rounded mt-3 border form-control text-dark">{{ post.content|safe }}</div>
    <!-- Campo hidden para enviar HTML para o backend -->
    <input id="post-content" name="content" type="hidden">

    <!-- Tag -->
    <label for="post-tag" style="font-weight: 600; margin-top: 14px;">Tag</label>
    <select id="post-tag" name="tag"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #dcdcdc; margin: 6px 0 14px;">
      <option value="doubt"     {% if post.tag == 'doubt' %}selected{% endif %}>Doubt</option>
      <option value="sugestion" {% if post.tag == 'sugestion' %}selected{% endif %}>Suggestion</option>
      <option value="strategy"  {% if post.tag == 'strategy' %}selected{% endif %}>Strategy</option>
    </select>

    <!-- Comunidade -->
    <label for="post-community" style="font-weight: 600;">Comunidade</label>
    <select id="post-community" name="community"
            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #dcdcdc; margin: 6px 0 14px;">
      {% for community in communities %}
        <option value="{{ community.id }}" {% if post.community.id == community.id %}selected{% endif %}>
          {{ community.name }}
        </option>
      {% endfor %}
    </select>

    <!-- Upload de arquivo -->
    <label for="post-file" style="font-weight: 600;">Anexar arquivo</label>
    <input id="post-file" name="file" type="file"
           style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #dcdcdc; margin: 6px 0 16px;">

    <button type="submit"
            style="background: #4CAF50; color: #fff; border: 0; padding: 12px 16px; border-radius: 10px; font-weight: 700; cursor: pointer;">
      {% if post.id %}‚úÖ Salvar{% else %}üöÄ Criar{% endif %}
    </button>
  </form>
</div>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>


<script>

document.addEventListener('DOMContentLoaded', function () {
    const quill = new Quill('#post-editor', {
        theme: 'snow',
        placeholder: 'Write something',
        modules: {
            toolbar: [
                [
                    {'font': []},
                    {'header': []},
                    {'align': []},
                    'bold', 'italic', 'underline', 'strike', 'blockquote',
                    {'color': []},
                    {'background': []},
                ],
                ['code-block', 'link'],
                ['clean'],
                ['image']
            ]
        },
        class:"rounded border"
    });

    quill.getModule('toolbar').container.classList.add(
        'rounded', 'border'
    );

    quill.clipboard.addMatcher('img', function(node, delta) {
        node.setAttribute(
            'style',
            'max-width:400px; height:auto; border-radius:12px; border:3px solid #4CAF50; margin-top:15px;'
        );
        return delta;
    });

    const form = document.getElementById('post-form');
    const hidden = form.querySelector('#post-content');

    function sync() { hidden.value = quill.root.innerHTML; }
    quill.on('text-change', sync);
    sync();
    form.addEventListener('submit', sync);

});

</script>

{% endblock content %}
