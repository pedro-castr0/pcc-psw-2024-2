{% load static %}

<div class="comment {% if comment.parent %}reply{% endif %}">
    <div class="comment">
        <div class="d-flex mt-3">
            <img 
                src="{% if comment.author.profile.profile_picture %} {{ comment.author.profile.profile_picture.url }} {% else %} {% static 'img/gradient-02.jpg' %} {% endif %}" 
                class="rounded-circle border circle-picture">

            <div class="ml-3 flex-grow-1">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <p class="font-weight-bold mb-0 text-content">
                            <a href="/user/profile/{{ comment.author.profile.id }}" class="text-decoration-none text-secondary">
                                @{{ comment.author.username }}
                            </a>
                        </p>
                        <p class="mb-0 text-muted ml-1 text-content">
                            âˆ™ {{ comment.posted|date:"M d, Y" }}
                        </p>
                    </div>

                    <button type="button" class="btn d-flex align-items-center justify-content-center rounded-circle p-0 button-small-circle">
                        <i class="fas fa-fw fa-ellipsis-v text-dark text-tertiary"></i>
                    </button>
                </div>

                <p class="mb-2 text-dark">{{ comment.content }}</p>

                <div class="d-flex">
                    <button class="btn btn-dark d-flex align-items-center justify-content-center border px-3 py-1 button-small-square"
                            onclick="toggleReplyForm('{{ comment.id }}')">
                        <i class="fas fa-fw fa-reply"></i>
                        <span class="mb-0 ml-1 text-tertiary font-weight-bold">Reply</span>
                    </button>
                </div>

                <div id="reply-form-{{ comment.id }}" class="mt-2 d-none">
                    <form method="post" action="{% url 'comment' %}" 
                        class="w-100 reply-form"
                        data-post-id="{{ comment.post.id }}" 
                        data-comment-id="{{ comment.id }}">

                        {% csrf_token %}

                        <div class="comment-box">
                            <textarea 
                                class="form-control rounded comment-form text-tertiary"
                                name="content" 
                                rows="2" 
                                placeholder="Write your reply..."
                                required
                                style="font-size: 14px;"></textarea>

                            <input type="hidden" name="post" value="{{ comment.post.id }}">
                            <input type="hidden" name="parent" value="{{ comment.id }}">

                            <div class="comment-actions">
                                <button type="button" 
                                        class="btn btn-dark d-flex align-items-center justify-content-center border button-small-square" 
                                        onclick="toggleReplyForm('{{ comment.id }}')">
                                    <span class="text-tertiary">Cancel</span>
                                </button>

                                <button type="submit"
                                        class="btn text-dark d-flex align-items-center justify-content-center rounded-circle p-0 button-small-circle">
                                    <i class="fas fa-fw fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="replies-{{ comment.id }}" class="ml-5 mt-3">
            {% for reply in comment.replies.all %}
                {% include "post/comment_section.html" with comment=reply %}
            {% endfor %}
        </div>
    </div>

    <div class="gap-3">

        {% if not comment.parent %}

            <div id="replies-{{ comment.id }}" class="d-none ml-5 mt-3">

                {% for reply in comment.replies.all %}

                    {% include "post/comment_section.html" with comment=reply %}

                {% endfor %}

            </div>

        {% else %}

            <div>

                {% for reply in comment.replies.all %}

                    {% include "post/comment_section.html" with comment=reply %}

                {% endfor %}

            </div>

        {% endif %}

    </div>
</div>

<script>
    function toggleReplies(comment_id, button) {
        let container = document.getElementById("replies-" + comment_id);

        if (container.classList.contains("d-none")) {
            container.classList.remove("d-none");
            button.innerHTML = '<i class="fas fa-fw fa-minus"></i>';

        } else {
            container.classList.add("d-none");
            button.innerHTML = '<i class="fas fa-fw fa-plus"></i>';
        }
    }

    function toggleReplyForm(comment_id) {
        let form = document.getElementById("reply-form-" + comment_id);
        if (form.classList.contains("d-none")) {
            form.classList.remove("d-none");
        } else {
            form.classList.add("d-none");
        }
    }
</script>
